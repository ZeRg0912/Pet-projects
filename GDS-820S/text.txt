ChatGPT (беседа № 1):

Для установки напряжения в 1 вольт и измерения тока с Keithley 2400, вам потребуется отправить соответствующие SCPI команды.

Вот обновленный код, который устанавливает напряжение в 1 вольт, затем измеряет ток и выводит его на экран:

#include <iostream>
#include <Windows.h>

void CALLBACK WriteCompletionRoutine(DWORD dwErrorCode, DWORD dwBytesTransferred, LPOVERLAPPED lpOverlapped) {
    // Пустая функция обратного вызова
}

int main() {
    HANDLE hComm;
    char portName[] = "COM1";
    DWORD baudRate = CBR_9600; // скорость передачи данных
    DCB dcb = {0};

    // Открытие COM-порта
    hComm = CreateFileA(portName, GENERIC_READ | GENERIC_WRITE, 0, NULL, OPEN_EXISTING, FILE_FLAG_OVERLAPPED, NULL);
    if (hComm == INVALID_HANDLE_VALUE) {
        std::cout << "Не удалось открыть COM-порт." << std::endl;
        return 1;
    }

    // Получение текущих настроек порта
    if (!GetCommState(hComm, &dcb)) {
        std::cout << "Не удалось получить настройки COM-порта." << std::endl;
        CloseHandle(hComm);
        return 1;
    }

    // Настройка параметров порта
    dcb.BaudRate = baudRate;
    dcb.ByteSize = 8; // бит данных
    dcb.Parity = NOPARITY; // проверка на четность
    dcb.StopBits = ONESTOPBIT; // количество стоп-бит
    if (!SetCommState(hComm, &dcb)) {
        std::cout << "Не удалось настроить COM-порт." << std::endl;
        CloseHandle(hComm);
        return 1;
    }

    // SCPI команда для установки напряжения в 1 вольт
    const char* setVoltageCommand = "SOURCE:VOLT:LEVEL 1";

    // Отправка SCPI команды установки напряжения
    DWORD bytesWritten;
    OVERLAPPED overlapped = { 0 };
    overlapped.hEvent = CreateEvent(NULL, TRUE, FALSE, NULL);

    if (!WriteFileEx(hComm, setVoltageCommand, strlen(setVoltageCommand), &overlapped, WriteCompletionRoutine)) {
        if (GetLastError() != ERROR_IO_PENDING) {
            std::cout << "Не удалось начать отправку данных." << std::endl;
            CloseHandle(hComm);
            return 1;
        }

        // Ожидание завершения отправки
        if (WaitForSingleObject(overlapped.hEvent, 5000) != WAIT_OBJECT_0) {
            CancelIo(hComm);
            std::cout << "Тайм-аут при отправке данных." << std::endl;
            CloseHandle(hComm);
            return 1;
        }

        // Получение результата отправки
        if (!GetOverlappedResult(hComm, &overlapped, &bytesWritten, FALSE)) {
            std::cout << "Не удалось получить результат отправки данных." << std::endl;
            CloseHandle(hComm);
            return 1;
        }
    }

    // SCPI команда для измерения тока
    const char* measureCurrentCommand = "MEASURE:CURR?";

    // Отправка SCPI команды измерения тока
    if (!WriteFile(hComm, measureCurrentCommand, strlen(measureCurrentCommand), &bytesWritten, NULL)) {
        std::cout << "Не удалось отправить SCPI команду." << std::endl;
        CloseHandle(hComm);
        return 1;
    }

    // Чтение ответа от Keithley 2400
    char response[256];
    DWORD bytesRead;
    overlapped.hEvent = CreateEvent(NULL, TRUE, FALSE, NULL);

    if (!ReadFile(hComm, response, sizeof(response) - 1, &bytesRead, &overlapped)) {
        if (GetLastError() != ERROR_IO_PENDING) {
            std::cout << "Не удалось начать чтение данных." << std::endl;
            CloseHandle(hComm);
            return 1;
        }

        // Ожидание завершения чтения
        if (WaitForSingleObject(overlapped.hEvent, 5000) != WAIT_OBJECT_0) {
            CancelIo(hComm);
            std::cout << "Тайм-аут при чтении данных." << std::endl;
            CloseHandle(hComm);
            return 1;
        }

        // Получение результата чтения

        if (!GetOverlappedResult(hComm, &overlapped, &bytesRead, FALSE)) {
            std::cout << "Не удалось получить результат чтения данных." << std::endl;
            CloseHandle(hComm);
            return 1;
        }
    }

    // Добавляем терминирующий символ null в конец строки
    response[bytesRead] = '\0';

    // Вывод ответа
    std::cout << "Ток измеренный Keithley 2400: " << response << std::endl;

    // Закрытие COM-порта
    CloseHandle(hComm);

    return 0;
}

Обратите внимание, что команда для установки напряжения в 1 вольт - это "SOURCE:VOLT:LEVEL 1". В коде добавлена отправка этой команды перед измерением тока.

Помимо этого, SCPI команда для измерения тока - это "MEASURE:CURR?". Она отправляется после установки напряжения.

Проверьте этот обновленный код для установки напряжения и измерения тока с Keithley 2400.

5876 из 16384